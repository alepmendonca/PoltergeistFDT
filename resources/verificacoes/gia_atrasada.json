{
  "verificacao": "GIAs entregues com atraso",
  "consulta": "/**\n * Verifica quais GIAs originais foram entregues com atraso, conforme art. 254\n * Inciso VII, alínea \"a\"\n */\nWITH referencia AS (\n\tSELECT DISTINCT date_trunc('month', i)::date AS periodo\n\tFROM generate_series(inicio_auditoria(), fim_auditoria(), '1 day'::interval) i\n\t\tJOIN cadesp_regime ON cadesp_regime.ie = ie_auditoria()\n\t\t\tAND cadesp_regime.regime = 'RPA'\n\t\t\tAND i BETWEEN cadesp_regime.inicio_regime AND COALESCE(cadesp_regime.fim_regime, NOW())\n), datas_limite AS (\n\tSELECT referencia.periodo AS referencia, \n\t\tCASE WHEN ie_auditoria()%10 IN (0,1) THEN end_of_month(referencia.periodo) + 11\n\t\tELSE CASE WHEN ie_auditoria()%10 IN (2,3,4) THEN end_of_month(referencia.periodo) + 12\n\t\tELSE CASE WHEN ie_auditoria()%10 IN (5,6,7) THEN end_of_month(referencia.periodo) + 13\n\t\tELSE end_of_month(referencia.periodo) + 13 END END END AS data_max_entrega\n\tFROM referencia\n), operacoes AS (\n\tSELECT date_trunc('month', nfe.emissao)::date AS referencia, sum(total_nfe) AS operacoes\n\tFROM nfe\n\tWHERE situacao_documento = 0\n\tAND ((cnpj_emit = cnpj_auditoria() AND tipo_doc_fiscal = 'Saída') OR (cnpj_dest = cnpj_auditoria() AND tipo_doc_fiscal = 'Entrada'))\n\tGROUP BY 1\n)\nSELECT gia_apuracao.referencia AS \"Referência\", entrega AS \"Entrega\", EXTRACT(DAY FROM entrega - datas_limite.data_max_entrega) AS \"Dias Atraso\", sum(total_nfe) AS \"Valor Operações\"\nFROM gia_apuracao \n\tJOIN datas_limite ON gia_apuracao.referencia = datas_limite.referencia\n\tJOIN nfe ON gia_apuracao.referencia = date_trunc('month', nfe.emissao)\nWHERE gia_apuracao.tipo = 'Normal'\nAND entrega > datas_limite.data_max_entrega\nAND ((cnpj_emit = cnpj_auditoria() AND tipo_doc_fiscal = 'Saída') OR (cnpj_dest = cnpj_auditoria() AND tipo_doc_fiscal = 'Entrada'))\nAND situacao_documento = 0\nGROUP BY 1, 2, 3\nORDER BY 1",
  "planilha_nome": "GIAs atrasadas",
  "infracoes": ["VIIa-atraso_entrega"]
}