{
  "consulta": "/**\n * Batimento entre entradas e saídas sem ter dados de entradas do Sintegra, pegando dados de matriz e filiais juntas (desconsidera transferências entre elas)\n * Agregação por gênero de NCM\n */\nWITH batimento AS (\n\tWITH e_x_s AS (\n\t\tSELECT dia, COALESCE(entradas.genero, saidas.genero) AS genero, \n\t\t\tentradas.quantidade AS qtd_entradas, entradas.total AS valor_entradas, entradas.icms AS icms_entradas,\n\t\t\tsum(entradas.quantidade) OVER window_entradas AS qtd_entradas_acumulada,\n\t\t\tsum(entradas.total) OVER window_entradas AS valor_entradas_acumulada,\n\t\t\tsum(entradas.icms) OVER window_entradas AS icms_entradas_acumulado,\n\t\t\tsaidas.quantidade AS qtd_saidas, saidas.total AS valor_saidas, saidas.icms AS icms_saidas,\n\t\t\tsum(saidas.quantidade) OVER window_saidas AS qtd_saidas_acumulada,\n\t\t\tsum(saidas.total) OVER window_saidas AS valor_saidas_acumulada,\n\t\t\tsum(saidas.icms) OVER window_saidas AS icms_saidas_acumulado\n\t\tFROM (SELECT generate_series(inicio_auditoria(), fim_auditoria(), INTERVAL '1 day')::date) AS d(dia)\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT nfent.\"Data Emissão\" AS entrada, ncment.\"NCM_2\" AS genero,\n\t\t\t\t\tSUM(ROUND((REPLACE(COALESCE((SELECT regexp_match(ndp.\"Descrição Produto\", '(\\d+\\,*\\d*)\\s*KG'))[1], '1'), ',', '.')::NUMERIC \n\t\t\t\t\t\t* nfitement.\"Quantidade Comercial\"::NUMERIC), 2)) AS quantidade, \n\t\t\t\t\tSUM(ROUND(nfitement.\"Valor Total NFE do Produto\"::NUMERIC, 2)) AS total,\n\t\t\t\t\tSUM(ROUND(nfitement.\"Valor ICMS\"::NUMERIC, 2)) AS icms\n\t\t\t\tFROM \"NFE\" AS nfent\n\t\t\t\t\tJOIN \"NFE-Detalhe\" AS nfitement \n\t\t\t\t\t\tJOIN \"Tabela NCM Níveis\" AS ncment ON ncment.\"Código NCM\" = nfitement.\"Código NCM\" \n\t\t\t\t\t\tJOIN \"NFE Descrição Produtos\" AS ndp ON ndp.\"Código Descrição Produto\" = nfitement.\"Código Descrição Produto\"\n\t\t\t\t\tON nfent.\"Código Chave NFE\" = nfitement.\"Código Chave NFE\"\n\t\t\t\tWHERE nfent.\"Indicador Tipo Documento Fiscal\" = 0\n\t\t\t\tAND cnpj_base(nfent.\"Número CNPJ Emitente\") != cnpj_base(nfent.\"Número CNPJ Destinatário\")\n\t\t\t\tGROUP BY 1, 2\n\t\t\t\tORDER BY 1, 2\n\t\t\t) AS entradas ON entradas.entrada = d.dia\n\t\t\tLEFT JOIN (\n\t\t\t\tSELECT saida, genero, sum(quantidade) AS quantidade, sum(total) AS total, sum(icms) AS icms\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT nfs.\"Data Emissão\" AS saida, ncms.\"NCM_2\" AS genero,\n\t\t\t\t\t\tSUM(ROUND((REPLACE(COALESCE((SELECT regexp_match(ndp.\"Descrição Produto\", '(\\d+\\,*\\d*)\\s*KG'))[1], '1'), ',', '.')::NUMERIC \n\t\t\t\t\t\t\t* nfitems.\"Quantidade Comercial\"::NUMERIC), 2)) AS quantidade, \n\t\t\t\t\t\tSUM(ROUND(nfitems.\"Valor Total NFE do Produto\"::NUMERIC, 2)) AS total,\n\t\t\t\t\t\tSUM(ROUND(nfitems.\"Valor ICMS\"::NUMERIC, 2)) AS icms\n\t\t\t\t\tFROM \"NFE\" AS nfs\t\n\t\t\t\t\t\tJOIN \"NFE-Detalhe\" AS nfitems\n\t\t\t\t\t\t\tJOIN \"Tabela NCM Níveis\" AS ncms ON ncms.\"Código NCM\" = nfitems.\"Código NCM\"\n\t\t\t\t\t\t\tJOIN \"NFE Descrição Produtos\" AS ndp ON ndp.\"Código Descrição Produto\" = nfitems.\"Código Descrição Produto\"\n\t\t\t\t\t\tON nfs.\"Código Chave NFE\" = nfitems.\"Código Chave NFE\"\n\t\t\t\t\tWHERE nfs.\"Indicador Tipo Documento Fiscal\" = 1\n\t\t\t\t\t\tAND cnpj_base(nfs.\"Número CNPJ Emitente\") != cnpj_base(nfs.\"Número CNPJ Destinatário\")\n\t\t\t\t\t\tAND nfitems.\"Código CFOP (04 Posições)\" != 5929\n\t\t\t\t\tGROUP BY 1, 2\n\t\t\t\t\tUNION\n\t\t\t\t\tSELECT sat.\"Data Emissao\" AS saida, ncms.\"NCM_2\" AS genero, \n\t\t\t\t\t\tSUM(ROUND(satitem.\"Quantidade Comercial\"::NUMERIC, 2)) AS quantidade, \n\t\t\t\t\t\tSUM(ROUND(satitem.\"Valor Produtos\"::NUMERIC, 2)) AS total,\n\t\t\t\t\t\tSUM(ROUND(satitem.\"Valor ICMS\"::NUMERIC, 2)) AS icms\n\t\t\t\t\tFROM \"SAT-CFe\" AS sat\n\t\t\t\t\t\tJOIN \"SAT-CFe_Itens\" AS satitem\n\t\t\t\t\t\t\tJOIN \"Tabela NCM Níveis\" AS ncms ON ncms.\"Código NCM\" = satitem.\"Código NCM\"\n\t\t\t\t\t\tON sat.\"CódigoCFe\" = satitem.\"CódigoCFe\"\n\t\t\t\t\tGROUP BY 1, 2\n\t\t\t\t) AS ss\n\t\t\t\tGROUP BY 1, 2\n\t\t\t\tORDER BY 1, 2\n\t\t\t) AS saidas ON saidas.saida = d.dia\n\tWHERE (entradas.genero IS NOT NULL OR saidas.genero IS NOT NULL)\n\tAND COALESCE(entradas.genero, saidas.genero) = COALESCE(saidas.genero, entradas.genero)\n\tWINDOW window_saidas AS (PARTITION BY saidas.genero, date_part('year', dia) ORDER BY saidas.genero, saidas.saida ROWS UNBOUNDED PRECEDING), \n\t\t\twindow_entradas AS (PARTITION BY entradas.genero, date_part('year', dia) ORDER BY entradas.genero, entradas.entrada ROWS UNBOUNDED PRECEDING)\n\tORDER BY d.dia\n\t)\n\tSELECT dia, genero, \n\t\tCOALESCE(qtd_entradas, 0) AS qtd_entradas,\n\t\tCOALESCE(valor_entradas, 0) AS valor_entradas,\n\t\tCOALESCE(icms_entradas, 0) AS icms_entradas,\n\t\tCOALESCE(FIRST_VALUE(qtd_entradas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), qtd_ent_grp ORDER BY genero, dia), 0) AS qtd_entradas_acumulada,\n\t\tCOALESCE(FIRST_VALUE(valor_entradas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), vl_ent_grp ORDER BY genero, dia), 0) AS valor_entradas_acumulada,\n\t\tCOALESCE(FIRST_VALUE(icms_entradas_acumulado) OVER (PARTITION BY genero, date_part('year', dia), icms_ent_grp ORDER BY genero, dia), 0) AS icms_entradas_acumulado,\n\t\tCOALESCE(qtd_saidas, 0) AS qtd_saidas,\n\t\tCOALESCE(valor_saidas, 0) AS valor_saidas,\n\t\tCOALESCE(icms_saidas, 0) AS icms_saidas,\n\t\tCOALESCE(FIRST_VALUE(qtd_saidas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), qtd_sai_grp ORDER BY genero, dia), 0) AS qtd_saidas_acumulada,\n\t\tCOALESCE(FIRST_VALUE(valor_saidas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), vl_sai_grp ORDER BY genero, dia), 0) AS valor_saidas_acumulada,\n\t\tCOALESCE(FIRST_VALUE(icms_saidas_acumulado) OVER (PARTITION BY genero, date_part('year', dia), icms_sai_grp ORDER BY genero, dia), 0) AS icms_saidas_acumulado\n\tFROM (SELECT *, \n\t\t\tSUM(CASE WHEN qtd_entradas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS qtd_ent_grp,\n\t\t\tSUM(CASE WHEN valor_entradas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS vl_ent_grp,\n\t\t\tSUM(CASE WHEN icms_entradas_acumulado IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS icms_ent_grp,\n\t\t\tSUM(CASE WHEN qtd_saidas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS qtd_sai_grp,\n\t\t\tSUM(CASE WHEN valor_saidas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS vl_sai_grp,\n\t\t\tSUM(CASE WHEN icms_saidas_acumulado IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS icms_sai_grp\n\t\t\tFROM e_x_s) t\n\tORDER BY dia\n), NCM_dados AS (\n\tSELECT DISTINCT genero AS \"NCM Gênero\", ncm.\"Descrição Nivel 2\" AS \"NCM Gênero Descrição\"\n\tFROM batimento JOIN \"Tabela NCM Níveis\" AS ncm ON batimento.genero = ncm.\"NCM_2\"\n) SELECT \n\t(date_trunc('year', dia) + interval '1 year' - interval '1 day')::date AS \"Período\", ncm_dados.*,\n\tqtd_entradas_acumulada AS \"Qtd. Entradas\", valor_entradas_acumulada AS \"Valor Entradas\", icms_entradas_acumulado AS \"ICMS Entradas\",\n\tqtd_saidas_acumulada AS \"Qtd. Saídas\", valor_saidas_acumulada AS \"Valor Saídas\", icms_saidas_acumulado AS \"ICMS Saídas\", \n\tqtd_entradas_acumulada - qtd_saidas_acumulada AS \"Saldo Estoque Apurado\", \n\tCASE WHEN qtd_entradas_acumulada = 0 THEN 0 ELSE ROUND(valor_entradas_acumulada/qtd_entradas_acumulada, 2) END AS \"Valor Médio Entradas\",\n\tCASE WHEN qtd_saidas_acumulada = 0 THEN 0 ELSE ROUND(valor_saidas_acumulada/qtd_saidas_acumulada,2) END AS \"Valor Médio Saídas\",\n\tCASE WHEN qtd_entradas_acumulada - qtd_saidas_acumulada < 0\n\t\tTHEN (qtd_saidas_acumulada - qtd_entradas_acumulada) * \n\t\t\tCASE WHEN qtd_entradas_acumulada = 0 THEN 0 ELSE ROUND(valor_entradas_acumulada/qtd_entradas_acumulada, 2) END\n\t\tELSE (qtd_entradas_acumulada - qtd_saidas_acumulada) * \n\t\t\tCASE WHEN qtd_saidas_acumulada = 0 THEN 0 ELSE ROUND(valor_saidas_acumulada/qtd_saidas_acumulada,2) END\n\tEND AS \"Valor Operações Apuradas\",\n\taliquota(ncm_dados.\"NCM Gênero\" * 1000, dia, 'SP') AS \"Alíquota Apurada\",\n\tCASE WHEN qtd_entradas_acumulada - qtd_saidas_acumulada > 0\n\t\tTHEN (qtd_entradas_acumulada - qtd_saidas_acumulada) * \n\t\t\tCASE WHEN qtd_saidas_acumulada = 0 THEN 0 ELSE ROUND(valor_saidas_acumulada/qtd_saidas_acumulada,2) END\n\t\tELSE 0\n\tEND * aliquota(ncm_dados.\"NCM Gênero\" * 1000, dia, 'SP')/100 AS \"ICMS Devido\"\nFROM batimento JOIN NCM_dados ON batimento.genero = ncm_dados.\"NCM Gênero\"\nWHERE (dia,genero) IN (SELECT max(dia), genero FROM batimento GROUP BY date_part('year', dia), genero)\nORDER BY genero, dia",
  "consulta_detalhamento": "/**\n * Detalhamento dos documentos fiscais usados no levantamento\n */\nWITH ncm_levantamento AS (\n\tWITH batimento AS (\n\t\tWITH e_x_s AS (\n\t\t\tSELECT dia, COALESCE(entradas.genero, saidas.genero) AS genero, \n\t\t\t\tentradas.quantidade AS qtd_entradas, entradas.total AS valor_entradas, entradas.icms AS icms_entradas,\n\t\t\t\tsum(entradas.quantidade) OVER window_entradas AS qtd_entradas_acumulada,\n\t\t\t\tsum(entradas.total) OVER window_entradas AS valor_entradas_acumulada,\n\t\t\t\tsum(entradas.icms) OVER window_entradas AS icms_entradas_acumulado,\n\t\t\t\tsaidas.quantidade AS qtd_saidas, saidas.total AS valor_saidas, saidas.icms AS icms_saidas,\n\t\t\t\tsum(saidas.quantidade) OVER window_saidas AS qtd_saidas_acumulada,\n\t\t\t\tsum(saidas.total) OVER window_saidas AS valor_saidas_acumulada,\n\t\t\t\tsum(saidas.icms) OVER window_saidas AS icms_saidas_acumulado\n\t\t\tFROM (SELECT generate_series(inicio_auditoria(), fim_auditoria(), INTERVAL '1 day')::date) AS d(dia)\n\t\t\t\tLEFT JOIN (\n\t\t\t\t\tSELECT nfent.\"Data Emissão\" AS entrada, ncment.\"NCM_2\" AS genero,\n\t\t\t\t\t\tSUM(ROUND((REPLACE(COALESCE((SELECT regexp_match(ndp.\"Descrição Produto\", '(\\d+\\,*\\d*)\\s*KG'))[1], '1'), ',', '.')::NUMERIC \n\t\t\t\t\t\t\t* nfitement.\"Quantidade Comercial\"::NUMERIC), 2)) AS quantidade, \n\t\t\t\t\t\tSUM(ROUND(nfitement.\"Valor Total NFE do Produto\"::NUMERIC, 2)) AS total,\n\t\t\t\t\t\tSUM(ROUND(nfitement.\"Valor ICMS\"::NUMERIC, 2)) AS icms\n\t\t\t\t\tFROM \"NFE\" AS nfent\n\t\t\t\t\t\tJOIN \"NFE-Detalhe\" AS nfitement \n\t\t\t\t\t\t\tJOIN \"Tabela NCM Níveis\" AS ncment ON ncment.\"Código NCM\" = nfitement.\"Código NCM\" \n\t\t\t\t\t\t\tJOIN \"NFE Descrição Produtos\" AS ndp ON ndp.\"Código Descrição Produto\" = nfitement.\"Código Descrição Produto\"\n\t\t\t\t\t\tON nfent.\"Código Chave NFE\" = nfitement.\"Código Chave NFE\"\n\t\t\t\t\tWHERE nfent.\"Indicador Tipo Documento Fiscal\" = 0\n\t\t\t\t\tAND cnpj_base(nfent.\"Número CNPJ Emitente\") != cnpj_base(nfent.\"Número CNPJ Destinatário\")\n\t\t\t\t\tGROUP BY 1, 2\n\t\t\t\t\tORDER BY 1, 2\n\t\t\t\t) AS entradas ON entradas.entrada = d.dia\n\t\t\t\tLEFT JOIN (\n\t\t\t\t\tSELECT saida, genero, sum(quantidade) AS quantidade, sum(total) AS total, sum(icms) AS icms\n\t\t\t\t\tFROM (\n\t\t\t\t\t\tSELECT nfs.\"Data Emissão\" AS saida, ncms.\"NCM_2\" AS genero,\n\t\t\t\t\t\t\tSUM(ROUND((REPLACE(COALESCE((SELECT regexp_match(ndp.\"Descrição Produto\", '(\\d+\\,*\\d*)\\s*KG'))[1], '1'), ',', '.')::NUMERIC \n\t\t\t\t\t\t\t\t* nfitems.\"Quantidade Comercial\"::NUMERIC), 2)) AS quantidade, \n\t\t\t\t\t\t\tSUM(ROUND(nfitems.\"Valor Total NFE do Produto\"::NUMERIC, 2)) AS total,\n\t\t\t\t\t\t\tSUM(ROUND(nfitems.\"Valor ICMS\"::NUMERIC, 2)) AS icms\n\t\t\t\t\t\tFROM \"NFE\" AS nfs\t\n\t\t\t\t\t\t\tJOIN \"NFE-Detalhe\" AS nfitems\n\t\t\t\t\t\t\t\tJOIN \"Tabela NCM Níveis\" AS ncms ON ncms.\"Código NCM\" = nfitems.\"Código NCM\"\n\t\t\t\t\t\t\t\tJOIN \"NFE Descrição Produtos\" AS ndp ON ndp.\"Código Descrição Produto\" = nfitems.\"Código Descrição Produto\"\n\t\t\t\t\t\t\tON nfs.\"Código Chave NFE\" = nfitems.\"Código Chave NFE\"\n\t\t\t\t\t\tWHERE nfs.\"Indicador Tipo Documento Fiscal\" = 1\n\t\t\t\t\t\t\tAND cnpj_base(nfs.\"Número CNPJ Emitente\") != cnpj_base(nfs.\"Número CNPJ Destinatário\")\n\t\t\t\t\t\t\tAND nfitems.\"Código CFOP (04 Posições)\" != 5929\n\t\t\t\t\t\tGROUP BY 1, 2\n\t\t\t\t\t\tUNION\n\t\t\t\t\t\tSELECT sat.\"Data Emissao\" AS saida, ncms.\"NCM_2\" AS genero, \n\t\t\t\t\t\t\tSUM(ROUND(satitem.\"Quantidade Comercial\"::NUMERIC, 2)) AS quantidade, \n\t\t\t\t\t\t\tSUM(ROUND(satitem.\"Valor Produtos\"::NUMERIC, 2)) AS total,\n\t\t\t\t\t\t\tSUM(ROUND(satitem.\"Valor ICMS\"::NUMERIC, 2)) AS icms\n\t\t\t\t\t\tFROM \"SAT-CFe\" AS sat\n\t\t\t\t\t\t\tJOIN \"SAT-CFe_Itens\" AS satitem\n\t\t\t\t\t\t\t\tJOIN \"Tabela NCM Níveis\" AS ncms ON ncms.\"Código NCM\" = satitem.\"Código NCM\"\n\t\t\t\t\t\t\tON sat.\"CódigoCFe\" = satitem.\"CódigoCFe\"\n\t\t\t\t\t\tGROUP BY 1, 2\n\t\t\t\t\t) AS ss\n\t\t\t\t\tGROUP BY 1, 2\n\t\t\t\t\tORDER BY 1, 2\n\t\t\t\t) AS saidas ON saidas.saida = d.dia\n\t\tWHERE (entradas.genero IS NOT NULL OR saidas.genero IS NOT NULL)\n\t\tAND COALESCE(entradas.genero, saidas.genero) = COALESCE(saidas.genero, entradas.genero)\n\t\tWINDOW window_saidas AS (PARTITION BY saidas.genero, date_part('year', dia) ORDER BY saidas.genero, saidas.saida ROWS UNBOUNDED PRECEDING), \n\t\t\t\twindow_entradas AS (PARTITION BY entradas.genero, date_part('year', dia) ORDER BY entradas.genero, entradas.entrada ROWS UNBOUNDED PRECEDING)\n\t\tORDER BY d.dia\n\t\t)\n\t\tSELECT dia, genero, \n\t\t\tCOALESCE(qtd_entradas, 0) AS qtd_entradas,\n\t\t\tCOALESCE(valor_entradas, 0) AS valor_entradas,\n\t\t\tCOALESCE(icms_entradas, 0) AS icms_entradas,\n\t\t\tCOALESCE(FIRST_VALUE(qtd_entradas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), qtd_ent_grp ORDER BY genero, dia), 0) AS qtd_entradas_acumulada,\n\t\t\tCOALESCE(FIRST_VALUE(valor_entradas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), vl_ent_grp ORDER BY genero, dia), 0) AS valor_entradas_acumulada,\n\t\t\tCOALESCE(FIRST_VALUE(icms_entradas_acumulado) OVER (PARTITION BY genero, date_part('year', dia), icms_ent_grp ORDER BY genero, dia), 0) AS icms_entradas_acumulado,\n\t\t\tCOALESCE(qtd_saidas, 0) AS qtd_saidas,\n\t\t\tCOALESCE(valor_saidas, 0) AS valor_saidas,\n\t\t\tCOALESCE(icms_saidas, 0) AS icms_saidas,\n\t\t\tCOALESCE(FIRST_VALUE(qtd_saidas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), qtd_sai_grp ORDER BY genero, dia), 0) AS qtd_saidas_acumulada,\n\t\t\tCOALESCE(FIRST_VALUE(valor_saidas_acumulada) OVER (PARTITION BY genero, date_part('year', dia), vl_sai_grp ORDER BY genero, dia), 0) AS valor_saidas_acumulada,\n\t\t\tCOALESCE(FIRST_VALUE(icms_saidas_acumulado) OVER (PARTITION BY genero, date_part('year', dia), icms_sai_grp ORDER BY genero, dia), 0) AS icms_saidas_acumulado\n\t\tFROM (SELECT *, \n\t\t\t\tSUM(CASE WHEN qtd_entradas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS qtd_ent_grp,\n\t\t\t\tSUM(CASE WHEN valor_entradas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS vl_ent_grp,\n\t\t\t\tSUM(CASE WHEN icms_entradas_acumulado IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS icms_ent_grp,\n\t\t\t\tSUM(CASE WHEN qtd_saidas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS qtd_sai_grp,\n\t\t\t\tSUM(CASE WHEN valor_saidas_acumulada IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS vl_sai_grp,\n\t\t\t\tSUM(CASE WHEN icms_saidas_acumulado IS NOT NULL THEN 1 END) OVER (PARTITION BY genero, date_part('year', dia) ORDER BY genero, dia) AS icms_sai_grp\n\t\t\t\tFROM e_x_s) t\n\t\tORDER BY dia\n\t)\n\tSELECT DISTINCT genero\n\tFROM batimento JOIN \"Tabela NCM Níveis\" AS ncm ON batimento.genero = ncm.\"NCM_2\"\n)\nSELECT CASE WHEN nf.\"Indicador Tipo Documento Fiscal\" = 0 THEN 'Entrada' ELSE 'Saída' END AS \"Entrada/Saída\",\n\tnc.\"Chave NFE\" AS \"Chave\", nf.\"Número Documento Fiscal\" AS \"Número\", nf.\"Código Série Documento Fiscal\" AS \"Série\", \n\tcnpj_cpf_formatted(nf.\"Número CNPJ Emitente\") AS \"CNPJ Emitente\", cnpj_cpf_formatted(nf.\"Número CNPJ Destinatário\") AS \"CNPJ Destinatário\", \n\tnf.\"Data Emissão\" AS \"Emissão\", nfitem.\"Número Item\" AS \"Item\", nfitem.\"Código NCM\" AS \"NCM\",\n\tROUND(nfitem.\"Quantidade Comercial\"::NUMERIC, 2) AS \"Quantidade\", nfitem.\"Unidade Comercial\" AS \"Unidade\", ndp.\"Descrição Produto\", \n\tROUND(nfitem.\"Valor Total NFE do Produto\"::NUMERIC, 2) AS \"Valor Produto\",\n\tROUND(nfitem.\"Valor ICMS\"::NUMERIC, 2) AS \"ICMS\"\n\tFROM \"NFE\" AS nf\n\t\tJOIN \"NFE Chave\" AS nc ON nf.\"Código Chave NFE\" = nc.\"Código Chave NFE\"\n\t\tJOIN \"NFE-Detalhe\" AS nfitem\n\t\t\tJOIN \"Tabela NCM Níveis\" AS ncm\n\t\t\t\tJOIN ncm_levantamento ON ncm_levantamento.genero = ncm.\"NCM_2\"\n\t\t\tON ncm.\"Código NCM\" = nfitem.\"Código NCM\" \n\t\t\tJOIN \"NFE Descrição Produtos\" AS ndp ON ndp.\"Código Descrição Produto\" = nfitem.\"Código Descrição Produto\"\n\t\tON nf.\"Código Chave NFE\" = nfitem.\"Código Chave NFE\"\n\tWHERE cnpj_base(nf.\"Número CNPJ Emitente\") != cnpj_base(nf.\"Número CNPJ Destinatário\")\nUNION\nSELECT 'Saída' AS \"Entrada/Saída\",\n\tsat.\"Chave CF-e\" AS \"Chave\", sat.\"Numero Cupom CF-e\" AS \"Número\", sat.\"Nr Serie - Nr Sat\" AS \"Série\",\n\tcnpj_cpf_formatted(cnpj_auditoria()) AS \"CNPJ Emitente\", NULL AS \"CNPJ Destinatário\", \n\tsat.\"Data Emissao\" AS \"Emissão\", satitem.\"Número Item\" AS \"Item\", satitem.\"Código NCM\" AS \"NCM\",\n\tROUND(satitem.\"Quantidade Comercial\"::NUMERIC, 2) AS \"Quantidade\", satitem.\"Unidade Comercial\" AS \"Unidade\", satitem.\"Descrição Produto\", \n\tROUND(satitem.\"Valor Produtos\"::NUMERIC, 2) AS \"Valor Produto\",\n\tROUND(satitem.\"Valor ICMS\"::NUMERIC, 2) AS \"ICMS\"\n\tFROM \"SAT-CFe\" AS sat\n\t\tJOIN \"SAT-CFe_Itens\" AS satitem\n\t\t\tJOIN \"Tabela NCM Níveis\" AS ncm \n\t\t\t\tJOIN ncm_levantamento ON ncm_levantamento.genero = ncm.\"NCM_2\"\n\t\t\tON ncm.\"Código NCM\" = satitem.\"Código NCM\"\n\t\tON sat.\"CódigoCFe\" = satitem.\"CódigoCFe\"\nORDER BY 1, 7, 3, 8",
  "infracoes": {
    "Ia": {
      "capitulacao": {
        "artigos": [
			{"artigo": "509"}
		]
      },
      "filtro": "positivo",
      "filtro_coluna": "Saldo Estoque Apurado",
      "planilha_titulo": "Levantamento fiscal com indicação de entradas sem saídas correspondentes",
      "provas": [
        {
          "descricao": "Apuração Fiscal, contendo a listagem de gêneros de NCM por ano em que ocorreu mais entradas que saídas, juntamente com memória de cálculo do imposto devido",
          "tipo": "listagem"
        },
        {
          "descricao": "Listagem de documentos fiscais utilizados no levantamento",
          "tipo": "listagem-detalhe"
        }
      ],
      "relato": "Deixou de pagar o ICMS no montante de @CRI, n<periodoAAAA>, decorrente de operações de saída de mercadoria tributadas omitidas ao fisco, apuradas por meio de levantamento fiscal realizado com fundamento no artigo 509 do RICMS/00, conforme descrito no Relatório Circunstanciado e apurado no Anexo do item, avaliando diferenças entre documentos fiscais de saída e entrada. Os valores de saída das mercadorias foram definidos (conforme resposta à notificação fiscal? por meio de aplicação de IVA setorial? por aplicação de valor médio de saídas?). Os documentos que comprovam o relatado encontram-se juntados no Anexo do item.",
      "relatorio_circunstanciado": "o contribuinte foi autuado por levantamento fiscal, nos termos do art. 509, decorrente de divergências entre os valores de mercadorias presentes em documentos fiscais em que o contribuinte consta como destinatário, e seus documentos fiscais de saida, considerando ainda a situação de estoque inicial e final.\nDurante o período avaliado, foi verificado que houve menos saidas de mercadorias que entradas, não tendo sido as mercadorias restantes localizadas no estoque do estabelecimento.\nOs valores das operações de saídas, representado na coluna Valor Operações Apuradas, compreende (depende do caso: pode ser o valor informado pelo contribuinte; pode ser a aplicação do IVA setorial sobre o valor médio de entrada; pode ser o valor médio das saídas conforme levantamento), multiplicado pela diferença de estoque levantada. Sobre estes valores, foi aplicada a alíquota de imposto definida no art. 509, §4º do RICMS/00, para definição do ICMS devido.\nA diferença apurada foi considerada como decorrente de operações tributadas, sendo calculado o imposto devido mediante a aplicação da alíquota prevista para cada NCM, nos termos do artigo 509, §4º do RICMS/00, conforme demonstrativo presente no Anexo do item."
    },
    "IIIc": {
      "filtro": "negativo",
      "filtro_coluna": "Saldo Estoque Apurado",
      "planilha_titulo": "Levantamento fiscal com indicação de saídas sem entradas correspondentes",
      "provas": [
        {
          "descricao": "Apuração Fiscal, contendo a listagem de gêneros de NCM por ano em que ocorreu mais saídas que entradas, juntamente com memória de cálculo do imposto devido",
          "tipo": "listagem"
        },
        {
          "descricao": "Listagem de documentos fiscais utilizados no levantamento",
          "tipo": "listagem-detalhe"
        }
      ],
      "relato": "Recebeu, n<periodoAAAA>, mercadorias desacompanhadas de documento fiscal, no valor de @CRO. Os valores supracitados foram apurados por meio de levantamento fiscal, realizado com fundamento no artigo 509 do RICMS/00, conforme descrito no Relatório Circunstanciado e apurado no Anexo do item, avaliando diferenças entre documentos fiscais de saída e entrada. Os valores de entrada das mercadorias foram definidos (conforme resposta à notificação fiscal? por meio de aplicação de IVA setorial? por aplicação de valor médio de entradas?). O ICMS devido, no valor de @CRI, foi exigido por solidariedade, nos termos do artigo 11, incisos XI e XII do RICMS/00. Os documentos que comprovam o relatado encontram-se juntados no Anexo do item.",
      "relatorio_circunstanciado": "o contribuinte foi autuado por recebimento de mercadorias desacompanhadas de documento fiscal, apurado em levantamento fiscal, previsto no art. 509, por avaliação entre documentos de entrada e saída do estabelecimento. \nForam localizados documentos fiscais eletrônicos em que consta a empresa como destinatária com quantidades de mercadorias inferior às quantidades saídas de mercadorias, sujeitas ao imposto, saídas conforme documentos fiscais de emissão própria.\nEstas inconsistências são indício de possível recebimento de mercadorias sujeitas ao imposto desacompanhadas de documento fiscal.\nOs valores das operações de entradas, representado na coluna Valor Operações Apuradas, compreende (depende do caso: pode ser o valor informado pelo contribuinte; pode ser a aplicação do IVA setorial invertido sobre o valor médio de saída; pode ser o valor médio das entradas conforme levantamento), multiplicado pela diferença de estoque levantada. Sobre estes valores, foi aplicada a alíquota de imposto definida no art. 509, §4º do RICMS/00, para definição do ICMS devido.\nO imposto sobre as operações anteriores de circulação de mercadorias foi cobrado do contribuinte em solidariedade, nos termos da Lei Estadual nº 6374/89."
    }
  },
  "notificacao": {
    "anexo": "Levantamento",
    "corpo": "No âmbito da Ordem de Serviço Fiscal <osf>, fica o contribuinte acima identificado NOTIFICADO a prestar informações sobre o motivo de não localização de entradas e/ou saidas suficientes para cada um dos gêneros de NCM em que se realizou levantamento fiscal, listados no anexo juntado. Foi juntada também listagem com os documentos fiscais utilizados no levantamento. Caso haja qualquer informação errada no levantamento, deve ser contestada precisamente (ex: informar documentos fiscais de entrada não considerados; classificações erradas de produtos; quantidades erradas de entrada ou saida) Não havendo documentos fiscais que acobertem as operações de circulação ocorridas, devem ser apresentados comprovantes dos valores das operações, ou estimativa de valores praticados.<br>Esclarecimentos sobre o levantamento fiscal realizado:<ul><li>O levantamento foi feito por ano, considerando-se todos os documentos fiscais (NF-e, SAT) em que os estabelecimentos do contribuinte constam como emitente ou destinatário até <fim_auditoria>, exceto eventuais documentos de transferência de mercadorias entre estabelecimentos;</li><li>\"NCM Gênero\" corresponde ao código e descrição referente aos primeiros 4 dígitos dos produtos, de forma a agrupar a variedade de NCMs e produtos presentes em documentos fiscais de entrada e saida localizados na base de dados desta Secretaria da Fazenda.</li><li>As quantidades do levantamento são apresentadas conforme o descrito nos documentos fiscais, podendo haver variação entre unidades diferentes.</li></ul><br><p><b>PRAZO PARA ATENDIMENTO</b>: 15 (quinze) dias, contados da ciência da notificação.<br><b>FORMA DE ATENDIMENTO</b>: Envio de declaração firmada por representante legal do contribuinte, digitalizada ou assinada digitalmente, eventual memória de cálculo realizada pelo contribuinte e provas que julgar apropriadas, por intermédio do SIPET - Sistema de Peticionamento Eletrônico, disciplinado pela Portaria CAT 83/20, que pode ser acessado através do endereço eletrônico https://www3.fazenda.sp.gov.br/sipet, utilizando a opção \"Comunicações\" -> \"Atendimento de notificação de fiscalização\".<br><b>BASE LEGAL</b>: Art. 494 do RICMS (Aprovado pelo Decreto 45.490/00).</p>",
    "titulo": "OSF <osf> - Levantamento Fiscal",
    "anexo_detalhamento": true
  },
  "planilha_nome": "LevantamentoNCM",
  "verificacao": "Levantamento Fiscal - por gênero NCM - comparando documentos"
}