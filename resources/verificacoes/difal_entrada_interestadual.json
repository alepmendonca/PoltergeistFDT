{
  "verificacao": "Divergências na declaração de Diferencial de alíquotas para entradas interestaduais",
  "consulta": "WITH ajustesxgia AS (\n\tWITH ajustesdifal AS (\n\t\tSELECT cabecalho_efd.dt_ini,\n\t\t\tCASE WHEN substr(ajustes.cod_aj_apur, 4, 1) = '0' THEN 'Débito'\n\t\t\tWHEN substr(ajustes.cod_aj_apur, 4, 1) = '1' THEN 'Débito'\n\t\t\tWHEN substr(ajustes.cod_aj_apur, 4, 1) = '2' THEN 'Crédito'\n\t\t\tWHEN substr(ajustes.cod_aj_apur, 4, 1) = '3' THEN 'Crédito'\n\t\t\tWHEN substr(ajustes.cod_aj_apur, 4, 1) = '4' THEN 'Crédito'\n\t\t\tWHEN substr(ajustes.cod_aj_apur, 4, 1) = '5' THEN 'Sem previsão em GIA'\n\t\t\tEND AS dc,\n\t\t\tajuste_tipo.codigo, ajustes.descr_compl_aj,\n\t\t\tsum(ajustes.vl_aj_apur) AS vl_aj_apur\n\t\tFROM reg_e111 AS ajustes\n\t\t\tJOIN reg_0000 as cabecalho_efd ON ajustes.efd = cabecalho_efd.efd\n\t\t\tJOIN efd_ajuste_icms AS ajuste_tipo ON ajustes.cod_aj_apur = ajuste_tipo.codigo\n\t\tWHERE cabecalho_efd.dt_ini BETWEEN ajuste_tipo.dt_ini AND COALESCE(ajuste_tipo.dt_fim, now())\n\t\t\tAND (ajuste_tipo.descricao ~ 'Diferencial de alíquota' OR (ajustes.descr_compl_aj ~* 'diferencial de al[i|í]quota' AND ajustes.descr_compl_aj !~* '87/2015'))\n\t\t\tAND cabecalho_efd.dt_ini BETWEEN inicio_auditoria() AND fim_auditoria()\n\t\tGROUP BY 1, 2, 3, 4\n\t)\n\tSELECT apuracao AS dt_ini, ajustesdifal.descr_compl_aj, COALESCE(dc, 'Não Declarado EFD') AS dc, vl_aj_apur, sum(gia_cfop.valor_contabil) AS \"GIA Valor Contábil\", sum(gia_cfop.icms_bc) AS \"GIA BC ICMS\", \n\t\tsum(gia_cfop.icms) AS \"GIA ICMS\", sum(gia_cfop.valor_isento) AS \"GIA Isento\", sum(gia_cfop.valor_outros) AS \"GIA Outros\"\n\tFROM gia_cfop  \n\t\t\tJOIN cfop ON gia_cfop.cfop = cfop.codigo\n\t\t\tLEFT JOIN ajustesdifal ON gia_cfop.apuracao = ajustesdifal.dt_ini\n\tWHERE gia_cfop.cfop BETWEEN 2500 AND 2599\n\tGROUP BY 1, 2, 3, 4\n), efdxnfe AS (\n\tWITH total_icms_itens AS (\n\t\tSELECT nfe_item.chave,\n\t\t\tround(sum(\n\t\t\t\t(nfe_item.valor_produto + nfe_Item.valor_frete + nfe_Item.valor_seguro + nfe_item.valor_outro + nfe_item.ipi - nfe_item.valor_desconto)\n\t\t\t\t*aliquota(nfe_item.ncm, nfe.emissao, nfe.uf_dest)/100), 2) AS icms_debito\n\t\tFROM nfe_item JOIN nfe ON nfe.chave = nfe_item.chave\n\t\tWHERE ((nfe.cnpj_dest = cnpj_auditoria() AND nfe.tipo_doc_fiscal = 'Saída' AND nfe.uf_emit != 'SP') \n\t\t\tOR (nfe.cnpj_emit = cnpj_auditoria() AND nfe.tipo_doc_fiscal = 'Entrada' AND nfe.uf_dest != 'SP'))\n\t\t\tAND nfe.situacao_documento = 0\n\t\t\tGROUP BY 1\n\t)\t\n\tSELECT DISTINCT cabecalho_efd.dt_ini, reg_c100.chv_nfe, reg_c100.num_doc, sum(reg_c190.vl_icms) AS credito_efd,\n\t\treg_c100.vl_doc, nfe_icms_difal_entrada(reg_c100.chv_nfe) AS icms_credito, total_icms_itens.icms_debito\n\tFROM reg_0000 AS cabecalho_efd\n\t\tJOIN reg_c190  \n\t\t\tJOIN reg_c100 \n\t\t\t\tJOIN total_icms_itens ON reg_c100.chv_nfe = total_icms_itens.chave \n\t\t\tON reg_c100.id = reg_c190.id_pai AND reg_c100.efd = reg_c190.efd \n\t\tON reg_c190.efd = cabecalho_efd.efd\n\tWHERE reg_c190.cfop BETWEEN 2500 AND 2599\n\t\tAND cabecalho_efd.dt_ini BETWEEN inicio_auditoria() AND fim_auditoria()\n\tGROUP BY 1, 2, 3, 5, 6, 7\n)\nSELECT meses.mes AS \"Período\", \n\tCOALESCE(creditos.vl_aj_apur, 0) AS \"Ajuste Crédito\", COALESCE(debitos.vl_aj_apur, 0) AS \"Ajuste Débito\",\n\tCOALESCE(sum(efdxnfe.icms_credito), 0) AS \"NFe Direito Crédito ICMS\", COALESCE(sum(efdxnfe.icms_debito), 0) AS \"NFe Débito Aplicação Alíq Interna\",\n\tCOALESCE(sum(efdxnfe.vl_doc), 0) AS \"NF-e Valor Contábil\",\n\tCOALESCE(debitos.\"GIA Valor Contábil\", creditos.\"GIA Valor Contábil\") AS \"GIA Valor Contábil\", \n\tCOALESCE(debitos.\"GIA BC ICMS\", creditos.\"GIA BC ICMS\") AS \"GIA BC ICMS\",\n\tCOALESCE(debitos.\"GIA ICMS\", creditos.\"GIA ICMS\") AS \"GIA ICMS\",\n\tCOALESCE(debitos.\"GIA Isento\", creditos.\"GIA Isento\") AS \"GIA Isento\",\n\tCOALESCE(debitos.\"GIA Outros\", creditos.\"GIA Outros\") AS \"GIA Outros\",\n\tCOALESCE(creditos.vl_aj_apur, 0) - COALESCE(sum(efdxnfe.icms_credito), 0) AS \"Crédito Indevido\",\n\tCOALESCE(sum(efdxnfe.icms_debito), 0) - COALESCE(debitos.vl_aj_apur, 0) AS \"ICMS Devido\"\nFROM (SELECT generate_series(inicio_auditoria(), fim_auditoria(), '1 month')::date AS mes) AS meses\n\tLEFT OUTER JOIN efdxnfe ON efdxnfe.dt_ini = meses.mes\n\tLEFT OUTER JOIN ajustesxgia AS debitos ON debitos.dt_ini = meses.mes AND debitos.dc = 'Débito'\n\tLEFT OUTER JOIN ajustesxgia AS creditos ON creditos.dt_ini = meses.mes AND creditos.dc IN ('Crédito', 'Não Declarado EFD')\nWHERE COALESCE(efdxnfe.dt_ini, COALESCE(debitos.dt_ini, creditos.dt_ini)) IS NOT NULL\nGROUP BY 1, 2, 3, 7, 8, 9, 10, 11\nHAVING \n\tabs(COALESCE(debitos.vl_aj_apur, 0) - COALESCE(sum(efdxnfe.icms_debito), 0)) > 1\n\t\tOR \n\tabs(COALESCE(creditos.vl_aj_apur, 0) - COALESCE(sum(efdxnfe.icms_credito), 0)) > 1\nORDER BY 1",
  "consulta_detalhamento": "WITH ajuste_cred AS (\n\tSELECT efd, descr_compl_aj, vl_aj_apur\n\tFROM reg_e111 JOIN efd_ajuste_icms ON reg_e111.cod_aj_apur = efd_ajuste_icms.codigo\n\tWHERE substr(cod_aj_apur, 4, 1) IN ('2','3', '4')\n\tAND (efd_ajuste_icms.descricao ~ 'Diferencial de alíquota' \n\t\tOR (reg_e111.descr_compl_aj ~* 'diferencial de al[i|í]quota' AND reg_e111.descr_compl_aj !~* '87/2015'))\n), ajuste_deb AS (\n\tSELECT efd, descr_compl_aj, vl_aj_apur\n\tFROM reg_e111 JOIN efd_ajuste_icms ON reg_e111.cod_aj_apur = efd_ajuste_icms.codigo\n\tWHERE substr(cod_aj_apur, 4, 1) IN ('0','1')\n\tAND (efd_ajuste_icms.descricao ~ 'Diferencial de alíquota' \n\t\tOR (reg_e111.descr_compl_aj ~* 'diferencial de al[i|í]quota' AND reg_e111.descr_compl_aj !~* '87/2015'))\n)\nSELECT DISTINCT cabecalho_efd.dt_ini AS \"Referência\", COALESCE(ajuste_deb.descr_compl_aj, ajuste_cred.descr_compl_aj) AS \"Descrição Contribuinte\",\n\tajuste_deb.vl_aj_apur AS \"Valor Ajuste Débito\", ajuste_cred.vl_aj_apur AS \"Valor Ajuste Crédito\", \n\tnfe.chave AS \"Chave\", nfe.numero AS \"Número\", nfe.emissao AS \"Emissão\", reg_c100.dt_e_s AS \"Entrada\", nfe.uf_emit AS \"UF Emitente\", \n\tnfe_item.item AS \"Item\", nfe_item.desc_produto AS \"Descrição Produto\",\n\tnfe_item.ncm AS \"NCM\",\n\tnfe_item.valor_produto + nfe_Item.valor_frete + nfe_Item.valor_seguro + nfe_item.valor_outro + nfe_item.ipi - nfe_item.valor_desconto AS \"BC ICMS Apurada\",\n\taliquota(nfe_item.ncm, nfe.emissao, nfe.uf_dest) AS \"Alíquota Interna Apurada\",\n\tround((nfe_item.valor_produto + nfe_Item.valor_frete + nfe_Item.valor_seguro + nfe_item.valor_outro + nfe_item.ipi - nfe_item.valor_desconto)\n\t\t*aliquota(nfe_item.ncm, nfe.emissao, nfe_item.desc_produto)/100, 2) AS \"Total Outros Débitos Apurados na NF-e\",\n\tnfe_icms_difal_entrada(nfe.chave) AS \"Total Outros Créditos Apurados na NF-e\", \n\tsum(reg_c190.vl_icms) AS \"EFD Credito ICMS\"\nFROM reg_c190\n\tLEFT JOIN reg_c170 ON reg_c190.id_pai = reg_c170.id_pai AND reg_c190.efd = reg_c170.efd AND reg_c190.cfop = reg_c170.cfop AND reg_c190.cst_icms = reg_c170.cst_icms\n\tJOIN reg_c100 \n\t\tJOIN nfe \n\t\t\tJOIN nfe_item ON nfe.chave = nfe_item.chave\n\t\tON reg_c100.chv_nfe = nfe.chave\n\tON reg_c100.id = reg_c190.id_pai AND reg_c100.efd = reg_c190.efd\n\tJOIN reg_0000 as cabecalho_efd ON reg_c190.efd = cabecalho_efd.efd\n\tJOIN cfop ON cfop.codigo = reg_c190.cfop\n\tLEFT JOIN ajuste_cred ON ajuste_cred.efd = reg_c190.efd\n\tLEFT JOIN ajuste_deb ON ajuste_deb.efd = reg_c190.efd\nWHERE cabecalho_efd.dt_ini BETWEEN inicio_auditoria() AND fim_auditoria()\nAND nfe.situacao_documento = 0\nAND reg_c190.cfop BETWEEN 2500 AND 2599\nGROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15\nORDER BY 1, 8, 6, 10",
  "planilha_nome": "Difal Interestadual",
  "notificacao": {
    "titulo": "OSF <osf> - Diferencial de Alíquotas",
    "corpo": "No âmbito da Ordem de Serviço Fiscal <OSF>, fica o contribuinte acima identificado NOTIFICADO a prestar informações sobre as divergências apuradas sobre a declaração de Outros Créditos e Outros Débitos lançados em Livro Registro de Apuração de ICMS em EFD, relacionados a diferencial de alíquota (art. 117 do RICMS/00).<br><br>O contribuinte deverá apresentar memória de cálculo realizada no momento da declaração, relacionando os documentos fiscais utilizados pelo contribuinte e eventuais divergências com as informações apuradas, presentes no anexo juntado.<br><p><b>PRAZO PARA ATENDIMENTO</b>: 10 (dez) dias, contados da ciência da notificação.<br><b>FORMA DE ATENDIMENTO</b>: Encaminhamento de declaração firmada por representante legal do contribuinte, digitalizada ou assinada digitalmente, e memória de cálculo por intermédio do SIPET - Sistema de Peticionamento Eletrônico, disciplinado pela Portaria CAT 83/20, que pode ser acessado através do endereço eletrônico https://www3.fazenda.sp.gov.br/sipet, utilizando a opção \"Comunicações\" -> \"Atendimento de notificação de fiscalização\".<br><b>BASE LEGAL</b>: Arts. 117 e 494 do RICMS (Aprovado pelo Decreto 45.490/00).</p>",
    "anexo": "Difal Entradas"
  },
  "infracoes": {
    "Il": {
      "filtro_coluna": "ICMS Devido",
      "filtro": "positivo",
      "planilha_titulo": "Falta de débitos na declaração de diferencial de alíquotas para entradas interestaduais",
      "relato": "Deixou de pagar o ICMS devido no valor total de @CRI, n<periodo>, conforme indicado no demonstrativo Anexo do item, relativo à diferença entre a alíquota interna e a alíquota interestadual devida na entrada de mercadorias destinadas a uso, consumo ou integração no ativo imobilizado, conforme se demonstra pelos documentos juntados.",
      "relatorio_circunstanciado": "o contribuinte foi autuado por ter declarado a menor, em Livro Registro de Apuração do ICMS, o valor devido de imposto, a este Estado, sobre o diferencial de alíquota interestadual, conforme art. 117, I do RICMS/00.",
      "provas": [
        {"tipo": "listagem", "descricao": "Listagem de referências em que foi feita a declaração a menor de diferencial de alíquota interestadual"},
        {"tipo": "GIA-OutrosDebitos", "descricao": "Detalhamento de Outros Débitos em GIA, demonstrando os valores destacados a título de diferencial de alíquota interestadual"},
        {"tipo": "LRAICMS", "descricao": "Livro Registro de Apuração de ICMS, demonstrando os valores destacados a título de diferencial de alíquota interestadual"}
      ],
      "capitulacao": {
        "limpa": true,
        "artigos": [
          {
            "artigo": "117",
            "inciso": "2"
          }
        ]
      }
    },
    "IIj": {
      "filtro_coluna": "Crédito Indevido",
      "filtro": "positivo",
      "planilha_titulo": "Créditos indevidos na declaração de diferencial de alíquotas para entradas interestaduais",
      "relato": "Creditou-se a maior indevidamente do imposto decorrente da aquisição de mercadorias com diferencial de alíquota, n<periodo>, no valor total de @CRO, conforme relação juntada no Anexo do item.",
      "capitulacao": {
        "limpa": true,
        "artigos": [
          {
            "artigo": "117",
            "inciso": "1"
          }
        ]
      }
    }
  }
}